"use strict";var video=$("#viewfinder")[0],canvas=document.querySelector("canvas"),ctx=canvas.getContext("2d"),localMediaStream=null,colors=[{name:"blue",R:0,G:0,B:255},{name:"red",R:255,G:0,B:0},{name:"yellow",R:255,G:255,B:0},{name:"orange",R:255,G:165,B:0},{name:"green",R:0,G:128,B:0}],currentIndex=0,question=$("#question")[0],questionContext=question.getContext("2d"),updateQuestion=function(){var a=colors[currentIndex];questionContext.beginPath(),questionContext.fillStyle="rgb("+a.R+","+a.G+","+a.B+")",questionContext.arc(50,50,10,0,2*Math.PI,!1),questionContext.fill(),currentIndex=(currentIndex+1)%colors.length},hasGetUserMedia=function(){return!!(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia)},onGetUserMedia=function(a){video.src=window.URL.createObjectURL(a),localMediaStream=a},onFailSoHard=function(a){console.log("エラー!",a)},calcColorDistInHSV=function(a,b){var c=function(a){var b,c,d,e=a.r,f=a.g,g=a.b,h=Math.max(e,f,g),i=Math.min(e,f,g);return h===i?b=0:h===e?b=(60*(f-g)/(h-i)+360)%360:h===f?b=60*(g-e)/(h-i)+120:h===g&&(b=60*(e-f)/(h-i)+240),c=0===h?0:255*((h-i)/h),d=h,{h:b,s:c,v:d}},d=c({r:a[0],g:a[1],b:a[2]}),e=c({r:b[0],g:b[1],b:b[2]}),f=180,g=255,h=5,i=1,j=Math.abs(d.h-e.h),k=Math.abs(d.s-e.s);return h*j/f+i*k/g},calcColorDist=function(a,b){var c=a[0]-b[0],d=a[1]-b[1],e=a[2]-b[2];return Math.sqrt(c*c+d*d+e*e)},judge=function(a){var b=1,c=$("#judgement")[0];c.textContent=b>=a?"OK":"NG",$("#colordump")[0].textContent=a},snapshot=function(){if(localMediaStream){var a=video.videoWidth,b=video.videoHeight;ctx.drawImage(video,a/2,b/2,1,1,0,0,640,480),document.querySelector("img").src=canvas.toDataURL("image/webp");var c=ctx.getImageData(0,0,1,1).data,d=questionContext.getImageData(50,50,1,1).data,e=calcColorDistInHSV(c,d);judge(e),updateQuestion()}};hasGetUserMedia()||window.alert("未対応ブラウザです"),window.URL=window.URL||window.webkitURL,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia({video:!0},onGetUserMedia,onFailSoHard),updateQuestion(),$("#capture").click(function(){snapshot()});